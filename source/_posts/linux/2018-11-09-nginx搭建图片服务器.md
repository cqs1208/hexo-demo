---
layout: post
title: Linux下安装Nginx并配置一个图片服务器
tags:
- Linux
categories: Linux
description: nginx
---

**本文采用二进制安装nginx并配置图片服务**

<!-- more --> 

1. nginx下载链接：http://nginx.org/en/download.html

2. 将安装包上传，解压，命令tar -zxvf nginx-1.10.3.tar.gz； 

3. 自定义创建一个文件夹作为Nginx安装目录，这里在home下创建nginx文件夹； 

   ```java
   [root@izbp12c0zpe8t4yri0xphiz nginx]# cd /project/nginx/
   [root@izbp12c0zpe8t4yri0xphiz nginx]# ll
   total 36
   drwx------ 2 nobody root 4096 Nov  8 18:01 client_body_temp
   drwxr-xr-x 2 root   root 4096 Nov  8 19:44 conf
   drwx------ 2 nobody root 4096 Nov  8 18:01 fastcgi_temp
   drwxr-xr-x 2 root   root 4096 Nov  8 17:33 html
   drwxr-xr-x 2 root   root 4096 Nov  8 18:29 logs
   drwx------ 2 nobody root 4096 Nov  8 18:01 proxy_temp
   drwxr-xr-x 2 root   root 4096 Nov  8 17:33 sbin
   drwx------ 2 nobody root 4096 Nov  8 18:01 scgi_temp
   drwx------ 2 nobody root 4096 Nov  8 18:01 uwsgi_temp
   ```

4. 在解压的文件夹（nginx-1.10.3）下执行`./configure --prefix=/project/nginx` （配置nginx安装目录）命令。  意思即配置安装环

   境，将会把Nginx安装到/project/nginx下;

​      若没有gcc，先安装  

```java
yum -y install gcc gcc-c++ autoconf automake make
```

​	若出现缺少依赖包则先安装依赖包，以下纯净centos mini版碰到的两个依赖包问题  

```java
./configure: error: the HTTP rewrite module requires the PCRE library. You can either disable the module by using --withou-http_rewrite_module option, or install the PCRE library into the system, or build the PCRE library statically from the source with nginx by using --with-pcre=<path> option
```

​	出现上面这个执行 yum -y install pcre-devel 安装依赖， 

```java
./configure: error: the HTTP gzip module requires the zlib library. You can either disable the module by using --withou-http_gzip_module option, or install the zlib library into the system, or build the zlib library statically from the source with nginx by using --with-zlib=<path> option
```

​	出现这个yum install -y zlib-devel 安装依赖， 

5. 编译：在解压的文件夹下先后执行make 和 make install 命令 
6. Nginx默认使用端口是80，这里直接先把Nginx端口改为8088，vi /home/nginx/conf/nginx.conf，修改server的端口，并配置一个图片服务器 (下图为部分nginx.conf配置)

```java
server {
        listen       8088;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location ~ .*\.(gif|jpg|jpeg|png)$ {  
            expires 24h;  
            root /home/images/;#指定图片存放路径  
            access_log /home/nginx/logs/images.log;#图片 日志路径  
            proxy_store on;  
            proxy_store_access user:rw group:rw all:rw;  
            proxy_temp_path         /home/images/;#代理临时路径
            proxy_redirect          off;  

            proxy_set_header        Host 127.0.0.1;  
            proxy_set_header        X-Real-IP $remote_addr;  
            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;  
            client_max_body_size    10m;  
            client_body_buffer_size 1280k;  
            proxy_connect_timeout   900;  
            proxy_send_timeout      900;  
            proxy_read_timeout      900;  
            proxy_buffer_size       40k;  
            proxy_buffers           40 320k;  
            proxy_busy_buffers_size 640k;  
            proxy_temp_file_write_size 640k;  
            if ( !-e $request_filename)  
            {  
                 proxy_pass  http://127.0.0.1:8088;#代理访问地址  
            }  
        }
    
        location /images/ {
       	 	root  /project/nginx/;
        	autoindex on;
    	}  ## 配置 images 映射到 /project/nginx/images/路径

        location / {
            root   html;
            index  index.html index.htm;
        }
```

7. 生成pid文件 /project/nginx/sbin/nginx -c /project/nginx/conf/nginx.conf。  

8. 启动：/project/nginx/sbin/nginx -s reload 

9. 使用chkconfig进行管理 

   - 编辑/etc/init.d/nginx文件

     ```java
     #!/bin/sh
     #
     # nginx - this script starts and stops the nginx daemon
     #
     # chkconfig:   - 85 15
     # description:  NGINX is an HTTP(S) server, HTTP(S) reverse \
     #               proxy and IMAP/POP3 proxy server
     # processname: nginx
     # config:      /etc/nginx/nginx.conf
     # config:      /etc/sysconfig/nginx
     # pidfile:     /var/run/nginx.pid
      
     # Source function library.
     . /etc/rc.d/init.d/functions
      
     # Source networking configuration.
     . /etc/sysconfig/network
      
     # Check that networking is up.
     [ "$NETWORKING" = "no" ] && exit 0
     # <span style="color:#ff0000;">1 - 修改这里↓</span>
     nginx="/usr/sbin/nginx"
     prog=$(basename $nginx)
     # <span style="color:#ff0000;">2 - 修改这里↓</span>
     NGINX_CONF_FILE="/etc/nginx/nginx.conf"
      
     [ -f /etc/sysconfig/nginx ] && . /etc/sysconfig/nginx
      
     lockfile=/var/lock/subsys/nginx
      
     make_dirs() {
        # make required directories
        user=`$nginx -V 2>&1 | grep "configure arguments:.*--user=" | sed 's/[^*]*--user=\([^ ]*\).*/\1/g' -`
        if [ -n "$user" ]; then
           if [ -z "`grep $user /etc/passwd`" ]; then
              useradd -M -s /bin/nologin $user
           fi
           options=`$nginx -V 2>&1 | grep 'configure arguments:'`
           for opt in $options; do
               if [ `echo $opt | grep '.*-temp-path'` ]; then
                   value=`echo $opt | cut -d "=" -f 2`
                   if [ ! -d "$value" ]; then
                       # echo "creating" $value
                       mkdir -p $value && chown -R $user $value
                   fi
               fi
            done
         fi
     }
      
     start() {
         [ -x $nginx ] || exit 5
         [ -f $NGINX_CONF_FILE ] || exit 6
         make_dirs
         echo -n $"Starting $prog: "
         daemon $nginx -c $NGINX_CONF_FILE
         retval=$?
         echo
         [ $retval -eq 0 ] && touch $lockfile
         return $retval
     }
      
     stop() {
         echo -n $"Stopping $prog: "
         killproc $prog -QUIT
         retval=$?
         echo
         [ $retval -eq 0 ] && rm -f $lockfile
         return $retval
     }
      
     restart() {
         configtest || return $?
         stop
         sleep 1
         start
     }
      
     reload() {
         configtest || return $?
         echo -n $"Reloading $prog: "
         killproc $nginx -HUP
         RETVAL=$?
         echo
     }
      
     force_reload() {
         restart
     }
      
     configtest() {
       $nginx -t -c $NGINX_CONF_FILE
     }
      
     rh_status() {
         status $prog
     }
      
     rh_status_q() {
         rh_status >/dev/null 2>&1
     }
      
     case "$1" in
         start)
             rh_status_q && exit 0
             $1
             ;;
         stop)
             rh_status_q || exit 0
             $1
             ;;
         restart|configtest)
             $1
             ;;
         reload)
             rh_status_q || exit 7
             $1
             ;;
         force-reload)
             force_reload
             ;;
         status)
             rh_status
             ;;
         condrestart|try-restart)
             rh_status_q || exit 0
                 ;;
         *)
             echo $"Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest}"
             exit 2
     esac
     ```

     注：根据本地的实际路径，将代码中的:

     nginx="" 改为 nginx="/usr/local/nginx/sbin/nginx"

     NGINX_CONF_FILE="" 改为 NGINX_CONF_FILE="/usr/local/nginx/conf/nginx.conf"

   - 保存后设置文件的执行权限 

     ```java
     chmod a+x /etc/init.d/nginx
     ```

   - 至此就可以通过下面指令控制启动停止 

     ```java
     /etc/init.d/nginx start
     /etc/init.d/nginx stop
     ```

   - 上面的方法完成了用脚本管理nginx服务的功能，但是还是不太方便。

     先将nginx服务加入chkconfig管理列表：

     ```java
     chkconfig --add /etc/init.d/nginx
     ```

   - 加完这个之后，就可以使用service对nginx进行启动，重启等操作了。 

     ```java
     service nginx start
     service nginx stop
     ```

   - 设置终端模式开机启动： 

     ```java
     chkconfig nginx on
     ```

     

   

