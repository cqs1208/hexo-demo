---
layout: post
title: Mysql性能调优
tags:
- Mysql
categories: Mysql
description: Mysql
---

Mysql性能调优

<!-- more --> 

## 1 商业需求对性能的影响

### 1.1 不合理需求对性能的影响

​	**需求： 一个论坛帖子总量统计**

​	**附加条件：实时更新**

​	这个功能非常容易实现 。执行一条SELECT COUNT(*)的Query 就可以得到结果 。如果使用的Innodb 的存储引擎 。可以试想一下，如果存放帖子的表中已经有上千万的帖 子的时候，执行这条Query 语句需要多少成本？恐怕再好的硬件设备，恐怕都不可能在10 秒之内完成一 次查询 。

​	既然这样查询不行，那我们是不是该专门为这个功能建一个表，就只有一个字段，一条记录，就存 放这个统计量，每次有新的帖子产生的时候，都将这个值增加1，这样我们每次都只需要查询这个表就可 以得到结果了，这个效率肯定能够满足要求了。确实，查询效率肯定能够满足要求，可是如果我们的系 统帖子产生很快，在高峰时期可能每秒就有几十甚至上百个帖子新增操作的时候，恐怕这个统计表又要 成为大家的噩梦了。要么因为并发的问题造成统计结果的不准确，要么因为锁资源争用严重造成整体性 能的大幅度下降。 

​	这里问题的焦点不应该是实现这个功能的技术细节，而是在于这个功能的附加要求“实时更 新”上面。只要去掉了这个“实时更新”的附加条件，我们就可以非常容易的实现这个功能了。就像之前所提 到的那样，通过创建一个统计表，然后通过一个定时任务每隔一定时间段去更新一次里面的统计值，这 样既可以解决统计值查询的效率问题，又可以保证不影响新发贴的效率，一举两得。 

​	实际上，在我们应用的系统中还有很多很多类似的功能点可以优化。如某些场合的列表页面参与列 表的数据量达到一个数量级之后，完全可以不用准确的显示这个列表总共有多少条信息，总共分了多少 页，而只需要一个大概的估计值或者一个时间段之前的统计值。这样就省略了我们的分页程序需要在分 以前实时COUNT 出满足条件的记录数。 其实，在很多应用系统中，实时和准实时，精确与基本准确，在很多地方所带来的性能消耗可能是 几个性能的差别。在系统性能优化中，应该尽量分析出那些可以不实时和不完全精确的地方，作出一些 相应的调整，可能会给大家带来意想不到的巨大性能提升。 

### 1.2 无用功能堆积

​	为系统增加某个功能 后，很少有公 司能做到及时将系统中某些不合适的功能下线。所以，我们所面对的应用系统可能总是越来越复杂，越 来越庞大，短期内的复杂可能并无太大问题，但是随着时间的积累，我们所面对的系统就会变得极其臃 肿。不仅维护困难，性能也会越来越差。尤其是有些并不合理的功能，在设计之初或者是刚上线的时候 由于数据量较小，带来不了多少性能损耗。可随着时间的推移，数据库中的数据量越来越大，数据检索 越来越困难，对真个系统带来的资源消耗也就越来越大。 

​	而且，由于系统复杂度的不断增加，给后续其他功能的开发带来实现的复杂度，可能很多本来很简 单的功能，因为系统的复杂而不得不增加很多的逻辑判断，造成系统应用程序的计算量不断增加，本身 性能就会受到影响。而如果这些逻辑判断还需要与数据库交互通过持久化的数据来完成的话，所带来的 性能损失就更大，对整个系统的性能影响也就更大了。 

## 2 系统架构对性能的影响

​	所有数据都是适合在数据库中存放的吗？数据库为我们提供了太多的功能，反而让很多并不是太了解数据库的人，错误的使用数据库中很多并不太擅长、或对性能影响很大的功能，最后却全部怪罪到数据库身上。 

### 2.1 哪些数据不适合存数据库中

#### 2.1.1 二进制多媒体数据

​	将二进制多媒体数据存放在数据库中，一个问题是数据库空间资源耗用非常严重，另一个问题
是这些数据的存储很消耗数据库主机的CPU 资源。这种数据主要包括图片，音频、视频和其他一些
相关的二进制文件。这些数据的处理本不是数据的优势，如果我们硬要将他们塞入数据库，肯定会
造成数据库的处理资源消耗严重。

#### 2.1.2 流水队列数据

​	我们都知道，数据库为了保证事务的安全性（支持事务的存储引擎）以及可恢复性，都是需要
记录所有变更的日志信息的。而流水队列数据的用途就决定了存放这种数据的表中的数据会不断的
被INSERT，UPDATE 和DELETE，而每一个操作都会生成与之对应的日志信息。在MySQL 中，如果是支
持事务的存储引擎，这个日志的产生量更是要翻倍。而如果我们通过一些成熟的第三方队列软件来
实现这个Queue 数据的处理功能，性能将会成倍的提升。

#### 2.1.3  超大文本数据

​	对于5.0.3 之前的MySQL 版本，VARCHAR 类型的数据最长只能存放255 个字节，如果需要存储更
长的文本数据到一个字段，我们就必须使用TEXT 类型（最大可存放64KB）的字段，甚至是更大的
LONGTEXT 类型（最大4GB）。而TEXT 类型数据的处理性能要远比VARCHAR 类型数据的处理性能低下
很多。从5.0.3 版本开始，VARCHAR 类型的最大长度被调整到64KB 了，但是当实际数据小于255
Bytes 的时候，实际存储空间和实际的数据长度一样，可一旦长度超过255 Bytes 之后，所占用的存
储空间就是实际数据长度的两倍。
	所以，超大文本数据存放在数据库中不仅会带来性能低下的问题，还会带来空间占用的浪费问
题。

### 2.2 是否考虑了缓存

​	对于 Web 系统或者 APP 应用，是否有大量热读数据及无需及时变更的数据，然而这些数据可以考虑缓存起来，提高 MySQL 的性能及节约 DB 资源。比如笔者公司的优惠券列表、广告列表、配置规则信息等，属于用户附表信息，无需频繁更新，可以利用 Redis 缓存，让应用跑的更快，用户体验更好。

### 2.3 Schema 对系统性能影响

论坛帖子案例：假设现在是高并发的一个论坛系统。

​	你需要考虑高并发的论坛最高的并发在哪里？可能最高的并发是查看帖子标题列表，现在往往帖子标题后面会跟一个作者的昵称。然而根据需求帖子标题（作者昵称），这里需要关联（这里就需要有一个 join 查询），但是由于高并发业务尽量避免使用关联查询，尽量走单表查询，那此时就会在帖子表冗余作者的昵称，违反了范式设计，但是却提高了系统性能和 QPS。

关于 Schema 设计大多秉承的基础是基于范式设计，然而真实系统中其实个人总结有如下建立：

1. 短小、精简（字段选型、表列数、char(N)、varchar(N) 等）
2. 字段冗余
3. 大小字段拆分（text、varchar(255) 等）
4. 单表行数拆分

**最终的目的就是：表小、行小、字段小**

## 3 Mysql 查询命令

**1、进去指定schema 数据库（存放了其他的数据库的信息） **

mysql> use information_schema;   

**2、查询所有数据的大小 **      

mysql> select concat(round(sum(DATA_LENGTH/1024/1024),2),'MB') as data from TABLES;   

**3、查看指定数据库实例的大小，比如说数据库 yoon**       

mysql> select concat(round(sum(DATA_LENGTH/1024/1024),2),'MB') as data from TABLES where table_schema='yoon';   

**4、查看指定数据库的表的大小，比如说数据库 yoon 中的 yoon 表 **      

mysql> select concat(round(sum(DATA_LENGTH/1024/1024),2),'MB') as data from TABLES                   where table_schema='yoon' and table_name='yoon';   

**5、指定库的索引大小：**   

SELECT CONCAT(ROUND(SUM(index_length)/(1024*1024), 2), ' MB') AS 'Total Index Size' FROM TABLES  WHERE table_schema = 'sakila';    

**6、指定库的指定表的索引大小：**   

SELECT CONCAT(ROUND(SUM(index_length)/(1024*1024), 2), ' MB') AS 'Total Index Size' FROM TABLES  WHERE table_schema = 'test' and table_name='sakila';    

**7、一个库中的使用情况：**   

SELECT CONCAT(table_schema,'.',table_name) AS 'Table Name', CONCAT(ROUND(table_rows/1000000,4),'M') AS 'Number of Rows', CONCAT(ROUND(data_length/(1024*1024*1024),4),'G') AS 'Data Size', CONCAT(ROUND(index_length/(1024*1024*1024),4),'G') AS 'Index Size', CONCAT(ROUND((data_length+index_length)/(1024*1024*1024),4),'G') AS'Total'FROM information_schema.TABLES WHERE table_schema LIKE 'sakila'; 

[参考链接](https://www.cnblogs.com/xiaoblog/p/4200372.html)